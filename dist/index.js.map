{"version":3,"sources":["../src/domain/entities/Message.ts","../src/domain/entities/Project.ts","../src/domain/entities/ProjectManager.ts","../src/domain/entities/Session.ts","../src/domain/entities/SessionManager.ts","../src/domain/entities/Orchestrator.ts","../src/repository/orchestratorRepository.ts","../src/utils/normalizeCwd.ts","../src/factory/orchestratorFactory.ts","../src/gateway/ClaudeCodeGateway.ts","../src/index.ts"],"sourcesContent":["export enum EMessenger {\n  USER = \"user\",\n  SYSTEM = \"system\"\n}\n\nexport interface IMessage {\n  messenger: EMessenger,\n  content: String\n}\n\nexport class Message implements IMessage {\n  messenger: EMessenger\n  content: String\n\n  constructor({ messenger, content }: IMessage) {\n    this.messenger = messenger\n    this.content = content\n  }\n}\n","export interface IProject {\n  name: string\n  path: string\n}\n\nexport class Project implements IProject {\n  name: string\n  path: string\n\n  constructor(path: string, name: string) {\n    this.path = path\n    this.name = name\n  }\n}\n","import { type IProject } from \"./Project.ts\"\n\nexport interface IProjectManager {\n  projects: IProject[],\n  listProjects(): IProject[],\n  addProject(project: IProject): void\n}\n\nexport class ProjectManager implements IProjectManager {\n  projects: IProject[]\n\n  constructor(projects: IProject[] = []) {\n    this.projects = projects\n  }\n\n  addProject(project: IProject): void {\n    this.projects.push(project)\n  }\n\n  listProjects(): IProject[] {\n    return this.projects\n  }\n}\n","import { type IProject } from \"./Project.ts\"\nimport { type IMessage } from \"./Message.ts\";\n\nexport enum ESessionStatus {\n  ACTIVE = \"active\",\n  IDLE = \"idle\"\n}\n\nexport interface ISession {\n  status: ESessionStatus,\n  worktree: string,\n  project: IProject,\n  messages: IMessage[],\n  sendMessage(message: IMessage): void,\n  manualTakeover(): void\n}\n\nexport class Session implements ISession {\n  status: ESessionStatus\n  worktree: string\n  project: IProject\n  messages: IMessage[]\n\n  constructor(status: ESessionStatus = ESessionStatus.IDLE, worktree: string, project: IProject, messages: IMessage[] = []) {\n    this.status = status\n    this.worktree = worktree\n    this.project = project\n    this.messages = messages\n  }\n\n  sendMessage(message: IMessage): void {\n    this.messages.push(message)\n  }\n\n  manualTakeover(): void {\n    // TODO\n  }\n}\n\n","import { type ISession } from \"./Session.ts\"\n\nexport interface ISessionManager {\n  sessions: ISession[],\n  listSessions(): ISession[],\n  addSession(session: ISession): void\n}\n\nexport class SessionManager implements ISessionManager {\n  sessions: ISession[]\n\n  constructor(sessions: ISession[] = []) {\n    this.sessions = sessions\n  }\n\n  addSession(session: ISession): void {\n    this.sessions.push(session)\n  }\n\n  listSessions(): ISession[] {\n    return this.sessions\n  }\n}\n","import { EMessenger, type IMessage, Message } from \"./Message.ts\";\nimport { type IProject, Project } from \"./Project.ts\";\nimport { type IProjectManager, ProjectManager } from \"./ProjectManager.ts\";\nimport { ESessionStatus, Session, type ISession } from \"./Session.ts\";\nimport { type ISessionManager, SessionManager } from \"./SessionManager.ts\";\n\nexport interface IOrchestrator {\n  projectManager: IProjectManager,\n  sessionManager: ISessionManager,\n  newProject(...args: ConstructorParameters<typeof Project>): void,\n  listProjects(): IProject[],\n  newSession(...args: NewSessionArgs): void,\n  listSessions(): ISession[],\n  sendMessage(session: ISession, message: string): void,\n  listMessages(session: ISession): IMessage[],\n  takeoverSession(session: ISession): void\n}\n\ntype SessionCtorArgs = ConstructorParameters<typeof Session>\ntype NewSessionArgs = [worktree: SessionCtorArgs[1], project: SessionCtorArgs[2]]\n\nexport class Orchestrator implements IOrchestrator {\n  projectManager: IProjectManager\n  sessionManager: ISessionManager\n\n  constructor(projectManager: IProjectManager = new ProjectManager, sessionManager: ISessionManager = new SessionManager) {\n    this.projectManager = projectManager\n    this.sessionManager = sessionManager\n  }\n\n  newProject(...args: ConstructorParameters<typeof Project>): void {\n    const project = new Project(...args)\n    this.projectManager.addProject(project)\n  }\n\n  listProjects(): IProject[] {\n    return this.projectManager.listProjects()\n  }\n\n  newSession(...args: NewSessionArgs): void {\n    const session = new Session(ESessionStatus.IDLE, ...args)\n    this.sessionManager.addSession(session)\n  }\n\n  listSessions(): ISession[] {\n    return this.sessionManager.listSessions()\n  }\n\n  sendMessage(session: ISession, messageContent: string): void {\n    const message = new Message({ messenger: EMessenger.USER, content: messageContent })\n    session.sendMessage(message)\n  }\n\n  listMessages(session: ISession): IMessage[] {\n    return session.messages\n  }\n\n  takeoverSession(session: ISession): void {\n    session.manualTakeover()\n  }\n}\n","import { promises as fs } from \"node:fs\"\nimport { normalizeCwd } from \"../utils/normalizeCwd.ts\"\nimport type { IOrchestrator } from \"../domain/entities/Orchestrator.ts\"\nimport type { IProject } from \"../domain/entities/Project.ts\"\nimport type { ISession } from \"../domain/entities/Session.ts\"\nimport { OrchestratorFactory } from \"../factory/orchestratorFactory.ts\"\n\nconst filePath = normalizeCwd(\"~/.lazystarforge/data\")\n\nexport class OrchestratorRepository {\n  static async find() {\n    const rawProjects = await fs.readFile(filePath + \"/projects.json\", \"utf8\")\n    const rawSessions = await fs.readFile(filePath + \"/sessions.json\", \"utf8\")\n    const projects = JSON.parse(rawProjects)\n    const sessions = JSON.parse(rawSessions)\n\n    const orchestratorFactory = new OrchestratorFactory(projects, sessions)\n    const orchestrator = orchestratorFactory.generate()\n    return orchestrator\n  }\n\n  static async save(orchestrator: IOrchestrator) {\n    const projectsJson = await this.convertOrchestratorProjectsToJson(orchestrator.listProjects())\n    const sessionsJson = await this.convertOrchestratorSessionsToJson(orchestrator.listSessions())\n    await fs.writeFile(filePath + \"/projects.json\", projectsJson, \"utf8\")\n    await fs.writeFile(filePath + \"/sessions.json\", sessionsJson, \"utf8\")\n  }\n\n  private static async convertOrchestratorProjectsToJson(projects: IProject[]) {\n    return JSON.stringify(projects, null, 2)\n  }\n\n  private static async convertOrchestratorSessionsToJson(sessions: ISession[]) {\n    return JSON.stringify(sessions, null, 2)\n  }\n}\n","import os from \"node:os\"\nimport path from \"node:path\"\nimport fs from \"node:fs\"\n\nexport function normalizeCwd(p: string) {\n  const expanded =\n    p.startsWith(\"~/\") ? path.join(os.homedir(), p.slice(2)) :\n      p === \"~\" ? os.homedir() :\n        p\n\n  const abs = path.resolve(expanded)\n\n  if (!fs.existsSync(abs) || !fs.statSync(abs).isDirectory()) {\n    throw new Error(`Invalid cwd (does not exist or not a directory): ${abs}`)\n  }\n\n  return abs\n}\n","import { EMessenger, Message } from \"../domain/entities/Message.ts\"\nimport { Orchestrator } from \"../domain/entities/Orchestrator.ts\"\nimport { Project } from \"../domain/entities/Project.ts\"\nimport { ProjectManager } from \"../domain/entities/ProjectManager.ts\"\nimport { ESessionStatus, Session } from \"../domain/entities/Session.ts\"\n\nexport class OrchestratorFactory {\n  projectsJson: any\n  sessionsJson: any\n\n  constructor(projects: any, sessions: any) {\n    this.projectsJson = projects\n    this.sessionsJson = sessions\n  }\n\n  generate() {\n    const projects = this.parseProjects(this.projectsJson)\n    const sessions = this.parseSessions(this.sessionsJson)\n\n    return new Orchestrator(projects, sessions)\n  }\n\n  private parseProjects(projectsJson: any) {\n    const projects = projectsJson.map((json: any) => {\n      return new Project(json[\"path\"], json[\"name\"])\n    })\n\n    return new ProjectManager(projects)\n  }\n\n  private parseSessions(sessionsJson: any) {\n    const sessions = sessionsJson.map((json: any) => {\n      const status = this.parseSessionStatus(json[\"status\"])\n      const project = new Project(json[\"project\"][\"path\"], json[\"project\"][\"name\"])\n      const messages = this.parseMessages(json[\"messages\"])\n      return new Session(status, json[\"worktree\"], project, messages)\n    })\n\n    return sessions\n  }\n\n  private parseSessionStatus(input: string): ESessionStatus {\n    if ((Object.values(ESessionStatus) as string[]).includes(input)) {\n      return input as ESessionStatus\n    }\n    throw new Error(\"invalid session status\")\n  }\n\n  private parseMessages(messagesJson: any) {\n    const messages = messagesJson.map((json: any) => {\n      const messenger = this.parseMessenger(json[\"messenger\"])\n      return new Message({ messenger, content: json[\"content\"] })\n    })\n\n    return messages\n  }\n\n  private parseMessenger(input: string): EMessenger {\n    if ((Object.values(EMessenger) as string[]).includes(input)) {\n      return input as EMessenger\n    }\n    throw new Error(\"invalid messege messenger\")\n  }\n}\n","import { query } from \"@anthropic-ai/claude-agent-sdk\"\nimport type { ISession } from \"../domain/entities/Session.ts\"\n\nexport type ClaudeEvent =\n  | { type: \"assistant_text\", text: string }\n  | { type: \"tool_call\", name: string }\n  | { type: \"done\", subtype?: string }\n  | { type: \"raw\", message: unknown }\n\nexport class ClaudeCodeGateway {\n  static async *streamMessage(session: ISession, content: string): AsyncGenerator<ClaudeEvent> {\n    for await (const message of query({\n      prompt: content,\n      options: {\n        cwd: session.project.path\n      }\n    })) {\n      if (message.type === \"assistant\" && message.message?.content) {\n        for (const block of message.message.content) {\n          if (\"text\" in block) yield { type: \"assistant_text\", text: block.text }\n          else if (\"name\" in block) yield { type: \"tool_call\", name: block.name }\n        }\n      } else if (message.type === \"result\") {\n        yield { type: \"done\", subtype: message.subtype }\n      }\n    }\n  }\n}\n\n","#!/usr/bin/env node\n\nimport { Orchestrator } from \"./domain/entities/Orchestrator.ts\"\nimport { OrchestratorRepository } from \"./repository/orchestratorRepository.ts\"\nimport { CreateProjectUseCase } from \"./usecase/createProjectUseCase.ts\"\nimport { CreateSessionUseCase } from \"./usecase/createSessionUseCase.js\"\nimport { SendMessageUseCase } from \"./usecase/sendMessageUseCase.js\"\nimport { normalizeCwd } from \"./utils/normalizeCwd.ts\"\n\nconst projectPath = normalizeCwd(\"~/Projects/jbeat-games/\")\n// const project = await CreateProjectUseCase.createProject(\"jbeat-games\", projectPath)\n// const session = await CreateSessionUseCase.createSession(\"test_worktree\", project)\n\nconst orchestrator = new Orchestrator\norchestrator.newProject(\"./projects/test\", \"test\")\nconst project = orchestrator.listProjects()[0]\norchestrator.newSession('refactor_home_page', project)\nconst session = orchestrator.listSessions()[0]\norchestrator.sendMessage(session, 'test message')\n\n// await SendMessageUseCase.sendMessage(\"using the notion mcp, what's the title of this page https://www.notion.so/LazyStarForge-Initial-POC-2d1227e94f6180e999e2c6d5f2ea025d\", session)\n\n//session.messages.forEach((message) => {\n//  console.log(message)\n// })\n\nconsole.log(\"saving orchestrator\")\nawait OrchestratorRepository.save(orchestrator)\n\nconsole.log(\"finding orchestrator\")\nconst orchestratorNew = await OrchestratorRepository.find()\nconsole.log(orchestratorNew)\n\nconsole.log(\"lazystarforge\")\n"],"mappings":"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","names":["EMessenger","path","project","ESessionStatus","project","session","project","session","fs","project","fs","orchestrator"]}